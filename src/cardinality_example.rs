use std::collections::BTreeMap;

// =======================================================
// 1. ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®å®šç¾©
// =======================================================

#[derive(Debug, Clone)]
struct User {
    id: u32,
    name: String,
    // â†“ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£ãŒä½ã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ (æ€§åˆ¥)
    gender: String, 
    // â†“ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£ãŒé«˜ã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ (Eãƒ¡ãƒ¼ãƒ«)
    email: String, 
}

type UsersTable = Vec<User>;

// === ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®å®šç¾© ===
// æ€§åˆ¥ã«å¯¾ã™ã‚‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ (ä½ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£)
type GenderIndex = BTreeMap<String, Vec<u32>>;

// Eãƒ¡ãƒ¼ãƒ«ã«å¯¾ã™ã‚‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ (é«˜ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£)
type EmailIndex = BTreeMap<String, Vec<u32>>;

// =======================================================
// 2. ãƒ‡ãƒ¼ã‚¿ã¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
// =======================================================

fn setup_data() -> (UsersTable, GenderIndex, EmailIndex) {
    let mut table = UsersTable::new();
    let mut gender_index = GenderIndex::new();
    let mut email_index = EmailIndex::new();

    let total_data = 1000;
    let genders = vec!["ç”·æ€§", "å¥³æ€§", "ãã®ä»–"]; // éå¸¸ã«å°‘ãªã„ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³

    for i in 0..total_data {
        let gender = genders[i % genders.len()].to_string();
        let email = format!("user{}@example.com", i); // ã»ã¼å…¨ã¦ãƒ¦ãƒ‹ãƒ¼ã‚¯

        let user = User {
            id: i as u32 + 1,
            name: format!("User{}", i + 1),
            gender: gender.clone(),
            email: email.clone(),
        };

        let row_index = i as u32;
        table.push(user);

        // æ€§åˆ¥ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æ§‹ç¯‰
        gender_index.entry(gender).or_insert_with(Vec::new).push(row_index);
        
        // Eãƒ¡ãƒ¼ãƒ«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æ§‹ç¯‰
        email_index.entry(email).or_insert_with(Vec::new).push(row_index);
    }

    (table, gender_index, email_index)
}

// =======================================================
// 3. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ§‹é€ ã®å¯è¦–åŒ–ã¨èª¬æ˜
// =======================================================

fn print_index_structure(gender_index: &GenderIndex, email_index: &EmailIndex) {
    println!("\n=======================================================");
    println!("   ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£æ¯”è¼ƒ");
    println!("=======================================================");

    // --- ä½ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£ã®ä¾‹ (æ€§åˆ¥) ---
    println!("\n--- A. ä½ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ (Gender) ---");
    println!("-> ã‚­ãƒ¼ã®ç¨®é¡ãŒéå¸¸ã«å°‘ãªã„ (é‡è¤‡ãŒå¤šã„)");
    println!("-------------------------------------------------------");
    for (key, indices) in gender_index.iter() {
        println!("ã€ã‚­ãƒ¼: {}ã€‘ -> {} ä»¶ã®è¡ŒãŒãƒ’ãƒƒãƒˆ", key, indices.len());
    }
    println!("\n[è§£èª¬] æ€§åˆ¥ã®ã‚ˆã†ãªã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£ãŒä½ã„åˆ—ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å¼µã‚‹ã¨â€¦");
    println!("  - ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ã‚­ãƒ¼ãŒå°‘ãªãã€ä¸€ã¤ã®ã‚­ãƒ¼ã«å¤šæ•°ã®è¡ŒãŒã¶ã‚‰ä¸‹ãŒã‚‹ã€‚");
    println!("  - ä¾‹ãˆã°ã€Œç”·æ€§ã€ã§æ¤œç´¢ã—ã¦ã‚‚ã€å…¨ãƒ‡ãƒ¼ã‚¿ã®ç´„åŠåˆ†ãŒãƒ’ãƒƒãƒˆã™ã‚‹ãŸã‚ã€çµã‚Šè¾¼ã¿åŠ¹æœãŒè–„ã„ã€‚");
    println!("  - ã“ã®ã‚ˆã†ãªå ´åˆã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½¿ã‚ãšã«ãƒ•ãƒ«ã‚¹ã‚­ãƒ£ãƒ³ã—ãŸæ–¹ãŒé€Ÿã„ã“ã¨ã•ãˆã‚ã‚‹ã€‚");

    // --- é«˜ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£ã®ä¾‹ (Eãƒ¡ãƒ¼ãƒ«) ---
    println!("\n--- B. é«˜ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ (Email) ---");
    println!("-> ã‚­ãƒ¼ã®ç¨®é¡ãŒéå¸¸ã«å¤šã„ (ã»ã¼ãƒ¦ãƒ‹ãƒ¼ã‚¯)");
    println!("-------------------------------------------------------");
    let mut count = 0;
    for (key, indices) in email_index.iter() {
        if count < 5 { // æœ€åˆã®5ä»¶ã ã‘è¡¨ç¤º
            println!("ã€ã‚­ãƒ¼: {}ã€‘ -> {} ä»¶ã®è¡ŒãŒãƒ’ãƒƒãƒˆ", key, indices.len());
        }
        count += 1;
    }
    println!("... (å¤šæ•°ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªã‚­ãƒ¼ãŒç¶šã) ...");
    println!("ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«å«ã¾ã‚Œã‚‹ã‚­ãƒ¼ã®ç·æ•°: {} ä»¶", email_index.len());

    println!("\n[è§£èª¬] Eãƒ¡ãƒ¼ãƒ«ã®ã‚ˆã†ãªã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£ãŒé«˜ã„åˆ—ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å¼µã‚‹ã¨â€¦");
    println!("  - ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ã‚­ãƒ¼ãŒã»ã¼ãƒ¦ãƒ‹ãƒ¼ã‚¯ã§ã€ä¸€ã¤ã®ã‚­ãƒ¼ã«å°‘æ•°ã®è¡Œã—ã‹å¯¾å¿œã—ãªã„ (ç†æƒ³ã¯1è¡Œ)ã€‚");
    println!("  - ç‰¹å®šã®Eãƒ¡ãƒ¼ãƒ«ã§æ¤œç´¢ã™ã‚‹ã¨ã€ç›®çš„ã®è¡Œã«ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ãŸã‚ã€éå¸¸ã«é«˜é€Ÿã€‚");
    println!("  - ã“ã‚ŒãŒã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒæœ€ã‚‚åŠ¹æœã‚’ç™ºæ®ã™ã‚‹å…¸å‹çš„ãªã‚±ãƒ¼ã‚¹ã€‚");
}

// =======================================================
// 4. å®Ÿè¡Œ
// =======================================================

pub fn run() {
    println!("=======================================================");
    println!("   RDBã®ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£ç†è§£ãƒ‡ãƒ¢ ğŸš€");
    println!("=======================================================");
    
    let (_users_table, gender_index, email_index) = setup_data();

    print_index_structure(&gender_index, &email_index);

    println!("\n=======================================================");
    println!("   çµè«–");
    println!("=======================================================");
    println!("ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯ã€Œã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£ãŒé«˜ã„ã€åˆ— (ID, Eãƒ¡ãƒ¼ãƒ«ãªã©) ã«ä½œæˆã™ã‚‹ã¨æœ€ã‚‚åŠ¹æœçš„ã§ã™ã€‚");
    println!("é€†ã«ã€Œã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£ãŒä½ã„ã€åˆ— (æ€§åˆ¥, ãƒ•ãƒ©ã‚°ãªã©) ã§ã¯åŠ¹æœãŒè–„ã„ã‹ã€é€†åŠ¹æœã«ãªã‚‹ã“ã¨ã‚‚ã‚ã‚Šã¾ã™ã€‚");
    println!("=======================================================");
}
