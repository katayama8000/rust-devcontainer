use std::collections::BTreeMap;

// =======================================================
// 1. ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
// =======================================================

#[derive(Debug, Clone)]
struct Member {
    id: u32,
    name: String,
}

type MemberTable = Vec<Member>;

// åå‰åˆ—ã«å¯¾ã™ã‚‹B-treeã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
type NameIndex = BTreeMap<String, u32>; // åå‰ã¯ãƒ¦ãƒ‹ãƒ¼ã‚¯ã¨ä»®å®š

// =======================================================
// 2. ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
// =======================================================

fn setup_data() -> (MemberTable, NameIndex) {
    let mut table = MemberTable::new();
    let mut index = NameIndex::new();

    let members = vec![
        Member { id: 1, name: "Taro".to_string() },
        Member { id: 2, name: "Jiro".to_string() },
        Member { id: 3, name: "Saburo".to_string() },
        Member { id: 4, name: "Shiro".to_string() },
    ];

    for member in members {
        index.insert(member.name.clone(), member.id);
        table.push(member);
    }
    (table, index)
}

// =======================================================
// 3. æ¤œç´¢å‡¦ç†ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
// =======================================================

fn simulate_searches(_table: &MemberTable, _index: &NameIndex) {
    println!("\n=======================================================");
    println!("   ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒã€ŒåŠ¹ãã€æ¤œç´¢ã¨ã€ŒåŠ¹ã‹ãªã„ã€æ¤œç´¢");
    println!("=======================================================");

    // --- ã‚±ãƒ¼ã‚¹1: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒåŠ¹æœçš„ã«ä½¿ã‚ã‚Œã‚‹æ¤œç´¢ ---
    println!("\n--- âœ… ã‚±ãƒ¼ã‚¹1: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒåŠ¹ãæ¤œç´¢ (å®Œå…¨ä¸€è‡´) ---");
    println!("SQL: SELECT * FROM members WHERE name = 'Taro'");
    println!("[å®Ÿè¡Œè¨ˆç”»ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³]");
    println!("  -> `name`åˆ—ã®B-treeã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½¿ã„ã€ã‚­ãƒ¼'Taro'ã‚’ç›´æ¥æ¤œç´¢ (O(log N))ã€‚");
    println!("  -> è¦‹ã¤ã‹ã£ãŸIDã‚’å…ƒã«ã€ãƒ†ãƒ¼ãƒ–ãƒ«ã¸1å›ã ã‘ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã€‚éå¸¸ã«é«˜é€Ÿã€‚");

    // --- ã‚±ãƒ¼ã‚¹2: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åˆ—ã«é–¢æ•°ã‚’é©ç”¨ã—ãŸãŸã‚ã€åŠ¹ã‹ãªããªã‚‹ ---
    println!("\n--- âŒ ã‚±ãƒ¼ã‚¹2: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒåŠ¹ã‹ãªã„æ¤œç´¢ (åˆ—ã«é–¢æ•°ã‚’é©ç”¨) ---");
    println!("SQL: SELECT * FROM members WHERE UPPER(name) = 'TARO'");
    println!("[å®Ÿè¡Œè¨ˆç”»ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³]");
    println!("  -> `name`åˆ—ã®å€¤ã«`UPPER`é–¢æ•°ã‚’é©ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯ä½¿ãˆãªã„ã€‚");
    println!("  -> **ãƒ•ãƒ«ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚­ãƒ£ãƒ³**ãŒç™ºç”Ÿã€‚ãƒ†ãƒ¼ãƒ–ãƒ«ã®å…¨è¡Œã«å¯¾ã—ã¦`UPPER(name)`ã‚’å®Ÿè¡Œã—ã€çµæœã‚’æ¯”è¼ƒã™ã‚‹ã€‚ä½é€Ÿã€‚");
    println!("  -> [å¯¾ç­–] DBã«ã‚ˆã£ã¦ã¯é–¢æ•°ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆã™ã‚‹ã‹ã€æ¤œç´¢å‰ã«ã‚¢ãƒ—ãƒªå´ã§å€¤ã‚’å¤§æ–‡å­—ã«å¤‰æ›ã™ã‚‹ã€‚");

    // --- ã‚±ãƒ¼ã‚¹3: LIKEæ¤œç´¢ã§å‰æ–¹ãŒãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ã®ãŸã‚ã€åŠ¹ã‹ãªããªã‚‹ ---
    println!("\n--- âŒ ã‚±ãƒ¼ã‚¹3: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒåŠ¹ã‹ãªã„æ¤œç´¢ (LIKEã®å‰æ–¹ä¸ä¸€è‡´) ---");
    println!("SQL: SELECT * FROM members WHERE name LIKE '%ro'");
    println!("[å®Ÿè¡Œè¨ˆç”»ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³]");
    println!("  -> `name`åˆ—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯å…ˆé ­æ–‡å­—ã‹ã‚‰ã‚½ãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€'%ro'ã®ã‚ˆã†ãªå¾Œæ–¹ä¸€è‡´æ¤œç´¢ã§ã¯ä½¿ãˆãªã„ã€‚");
    println!("  -> **ãƒ•ãƒ«ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚­ãƒ£ãƒ³**ãŒç™ºç”Ÿã€‚å…¨è¡Œã®`name`åˆ—ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã€‚ä½é€Ÿã€‚");

    // --- ã‚±ãƒ¼ã‚¹4: LIKEæ¤œç´¢ã§ã‚‚å‰æ–¹ãŒä¸€è‡´ã—ã¦ã„ã‚Œã°ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒåŠ¹ã ---
    println!("\n--- âœ… ã‚±ãƒ¼ã‚¹4: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒåŠ¹ãæ¤œç´¢ (LIKEã®å‰æ–¹ä¸€è‡´) ---");
    println!("SQL: SELECT * FROM members WHERE name LIKE 'S%'");
    println!("[å®Ÿè¡Œè¨ˆç”»ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³]");
    println!("  -> ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½¿ã„ã€ã‚­ãƒ¼ãŒ'S'ã§å§‹ã¾ã‚‹ç¯„å›²ã‚’åŠ¹ç‡çš„ã«æ¤œç´¢ã§ãã‚‹ (ç¯„å›²ã‚¹ã‚­ãƒ£ãƒ³)ã€‚");
    println!("  -> ãƒ•ãƒ«ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚­ãƒ£ãƒ³ã‚ˆã‚Šã‚‚ãšã£ã¨é«˜é€Ÿã€‚");
}

// =======================================================
// 4. å®Ÿè¡Œ
// =======================================================

pub fn run() {
    println!("=======================================================");
    println!("   ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒåŠ¹ã‹ãªã„ã‚±ãƒ¼ã‚¹ã®ãƒ‡ãƒ¢ ğŸš€");
    println!("=======================================================");
    
    let (table, index) = setup_data();

    simulate_searches(&table, &index);

    println!("\n=======================================================");
    println!("   çµè«–");
    println!("=======================================================");
    println!("ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æœ‰åŠ¹ã«æ´»ç”¨ã™ã‚‹ã«ã¯ã€æ¤œç´¢ã‚¯ã‚¨ãƒªãŒã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æ§‹é€ ã«åˆã†ã‚ˆã†ã«æ›¸ãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚");
    println!("ç‰¹ã«WHEREå¥ã§ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åˆ—ã«é–¢æ•°ã‚’é©ç”¨ã—ãŸã‚Šã€å‰æ–¹ä¸ä¸€è‡´ã®LIKEæ¤œç´¢ã‚’ä½¿ã†ã¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒåŠ¹ã‹ãªããªã‚‹ã®ã§æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚");
    println!("=======================================================");
}
